# Mongo副本集

## 什么是副本集

## 副本集的特点

1. 副本集节点特性
   1. 无投票权节点
   2. 隐藏节点
   3. 延迟节点
   4. 低优先级节点
   5. 无索引节点
      1. 备份用
2. 副本集的限制条件
   1. 只能有7个有效的投票节点
      1. 从库从**元节点** 拷贝数据
3. 副本集的高可用性
   1. raft协议（pv1）
4. 副本集部署建议
   1. 一主两从，支持链式复制

## 副本集概要

### 单节点副本集

### 副本集的作用

1. 提供数据冗余
2. 提高可用性

### Oplog的本质

1. 本质上是一个特殊的固定集合(capped collection)，记录了数据库的所有操作
2. Oplog集合位于local系统库下名为local.oplog.rs
3. linux下默认5%的物理内存或WiredTiger下最小990MB
4. **oplog操作日志具有幂等性**
5. 数据不允许用户删除，修改增大，需要重建oplog或replSetResizeOplog

### Tail游标

1. 一种特殊的游标，当游标结果集迭代完后不会被关闭，可类比linux下的`tail -f`

## 副本集角色

### 0优先级节点

1. 不能当选为主，不能触发选举，可接受读，不能写，可参加投票
2. 手动添加0优先级节点
   1. rs.add({host:'ip:port', priority:0})
3. 使用场景
   1. 当主挂了之后，不希望不同机房的实例成为主，希望跟主同机房的节点成为主，这个时候就可以把跟主同机房的节点的priority设置为1， 而其他机房的节点设置为0，这样在主选举的时候，就会优先选择高优先级的节点。

### 投票节点（arbiter）

1. 投票节点不复制数据，所有需要独立添加认证信息，不能成为主库但具备投票权限
2. 3.6版本及其之后，优先级必须为0、投票节点只复制配置信息，心跳及选举信息
3. 手动添加投票节点
   1. rs.addArb("ip:port")

### 无投票普通节点

1. 不具有投票权限的节点，无投票节点优先级必须为0
2. 当副本及超过7个投票节点后，其他所有节点必须为无投票属性，否者无法添加
   1. 对多有7个节点，具有投票权
3. 手动添加无投票节点
   1. rs.add({host:"ip:port", priority:0, votes:0})

### 隐藏节点

1. 优先级必须是0，且不能当选为主，db.isMaster()输出不会显示隐藏节点
   1. 业务端的驱动主要使用`db.isMaster()`来获取节点的读写分离信息，以便设置读写分离
2. 不承担线上负载，常用于离线统计分析，备份，节点维护场景
3. 手动添加无投票节点
   1. rs.add({host:"ip:port", priority:0, hidden:true})

### 延迟节点

1. 优先级必须为0，建议设置隐藏属性，建议vote为0，延迟时间需要考虑oplog大小
2. 当vote为1时可参与投票但不可以当选为主，常用于线上业务误操作的情况
   1. 主要参数，设置slaveDelay，延迟比较大的一个时间，便于对误删的数据的恢复
3. 手动添加延迟节点

### 无索引节点

1. 优先级必须为0，建议设置隐藏属性避免线上负载，无索引并不包括id索引
2. 不允许对已有节点配置无索引属性，只能通过初始化添加或者先删除后添加的方式
3. 当vote为1时，可参与投票但不可当选为主，常用于ETL，全量拉数据或者备份场景
4. 手动添加无投票节点
   1. rs.add({host:"ip:port", priority:0, hidden:true, buildIndexes:false})

## 副本集节点状态转换

### STARTUP

1. 副本集每个成员以STARTUP启动或叫初始化副本集状态
2. 节点加载副本集配置信息后转化为STARTUP2状态
3. STARTUP状态成员不被认为副本集成员，没有投票资格

### STARTUP2

1. mongod加载完各个节点配置信息后进入STARTUP2状态
2. STARTUP2扎UN国泰街店被认为副本集有效节点，有投票权
3. 同时节点开始初始化数据同步，期间持续保持STARTUP2状态
   1. 这里的同步数据，主要指的是，一个新的节点加入到集群，需要从主库中同步数据到本地
4. 直到全量数据及索引同步完成后，节点进入RECOVERING状态

### RECOVERING

1. 出现场景
   1. 全量数据及索引同步完成后追oplog期间
   2. 源节点oplog覆盖写后的目标节点状态
   3. 一主一从架构内部认证不通过下的情况
2. 节点属性
   1. 不提供线上读访问
   2. 具备投票资格，但不能被选举为主
3. 状态转换
   1. 当节点数据足够到可以为业务提供读后，转换为SECONDARY状态

### PRIMARY

1. 出现场景
   1. 集群单个节点初始化后进入PRIMARY
2. 节点属性
   1. 一个副本集同一时刻只能有一个节点处于PRIMARY
   2. PRIMARY节点具备投票权利，提供线上读写访问
3. 状态装换
   1. PRIMARY发生切换，可转换为SECONDARY

### SECONDARY

1. 出现场景
   1. 主库执行rs.add()添加从节点数据复制正常后的状态
2. 节点属性
   1. 通过oplog持续复制元节点的数据更新操作
   2. 通过配置驱动参数可承担线上业务读请求
   3. 正常SECONDARY状态节点可参与投票
3. 状态转换
   1. 当PRIMARY崩溃或切换后SECONDARY可转换为PRIMARY
   2. 当源节点oplog写覆盖后可能会转换为RECOVERING

### Arbiter

1. 出现场景
   1. 主库执行`rs.addArb()`添加节点正常后的状态
2. 节点属性
   1. 无需复制源节点的更新操作
   2. 不承担线上业务的读请求
   3. 选举中值参与投票不能当选为主
3. 状态转换
   1. 无
   2. 在主库上创建的账号不能同步到这里，需要额外创建账号

### UNKNOWN

1. 出现场景
   1. 节点添加后的某个短暂的中间状态（节点与其他节点尚未有心跳检测）
2. 节点属性
   1. 不提供线上读访问，不参与投票
3. 状态转换
   1. 心跳检测正常后会转换为STARTUP2

### DOWN

1. 出现场景
   1. 副本集其他节点无法连接的节点被认为是DOWN状态
2. 节点属性
   1. 不提供线上读访问，不参与投票
3. 状态转换
   1. 有可能转换为RECOVERING  或者  SECONDARY

### REMOVED

1. 出现场景
   1. 节点被副本集剔除后的状态
2. 节点属性
   1. 不提供线上读访问，不参与投票，不同步数据
3. 状态转换
   1. 通过`rs.add()`或`rs.addArb()`可能转换为RECOVERING或SECONDARY或Arbiter

### Rollback

1. 出现场景
   1. 主从切换后主库尚有未复制到其他从库的文档
2. 节点属性
   1. 不能提供线上读访问
3. 状态转换
   1. 当数据节点与其他节点数据一致后，可转换为SECONDARY

### FATAL

1. 出现场景
   1. 节点触发了一个不可恢复错误（极其罕见，3.0版本后被删除）
2. 节点属性
   1. 不提供线上读访问，不参与投票，不同步数据
3. 状态转换
   1. 未知，可能需要重启并重新同步数据

## 副本集相关集合

1. oplog.rs
   1. oplog信息
2. replset.election
   1. 投票信息
3. replset.minvaid
   1. 记录Secondary节点数据是否处于一致性状态
4. Replset.oplogTruncateAfterPoint
   1. 非正常关闭的信息
5. system.replset
   1. 副本集配置信息
6. system.rollback.id

## notes

wiredtiger支持三种压缩模式

* none
* snappy
* zlib

1. mongo中字段不存在和字段为null有什么区别

   1. 例子中，我有两行数据

      ```
      {_id: 1, x: null}
      {_id: 2}
      ```

   2. 对于存在性查询，只会返回一个

      ```shell
      ===> db.test.find({x: {$exists: false}})
      {_id: 2}
      ```

   3. 对于null值查询，两个都会查出来

      ```shell
      ===> db.test.find({x: null})
      {_id: 1, x: null}
      {_id: 2}
      ```

   4. 如果按照type来查询，只会查出值为null的

      ```shell
      ===> db.test.find({x: {$type: 10}})
      {_id: 1, x: null}
      ```

      